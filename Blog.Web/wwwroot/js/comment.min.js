layui.use(["flow","laytpl"],function(){var n=layui.$,t=layui.flow,i=layui.laytpl;n(".comment-item").on("mouseover",function(){n(this).find(".reply").addClass("layui-show")}).on("mouseout",function(){n(this).find(".reply").removeClass("layui-show")});n(".comment-reply").on("mouseover",function(){n(this).find(".createtime a").show()}).on("mouseout",function(){n(this).find(".createtime a").hide()});n(".blog-body").on("click",function(){n("#commentReplyEritor").remove();n(".comment-item").find(".btnDiv,.layui-layedit").remove()});n(".comment-item").find(".btnDiv,.layui-layedit,.createtime a,.reply").click(function(n){layui.stope(n)});t.load({elem:".commentlist",isAuto:!0,end:"没有更多了",mb:200,done:function(t,r){var e,u=10,f=[];if(t==1){r(f.join(""),t<999999);return}n.ajax({type:"get",url:"/api/comment/getcommentsbypage",data:{pageIndex:t,pageSize:u},success:function(o){if(o.code===1){var s=commentTpl.innerHTML;i(s).render(o.data,function(n){f.push(n)});e=(o.count+u-1)/u;r(f.join(""),t<e);sr.reveal(".sr-bottom",{scale:1,opacity:.1,distance:"60px",duration:1e3});n(".comment-item").off("mouseover").on("mouseover",function(){n(this).find(".reply").addClass("layui-show")}).off("mouseout").on("mouseout",function(){n(this).find(".reply").removeClass("layui-show")});n(".comment-reply").off("mouseover").on("mouseover",function(){n(this).find(".createtime a").show()}).off("mouseout").on("mouseout",function(){n(this).find(".createtime a").hide()});n(".byflow").find("*[blog-event]").on("click",function(){var t=n(this).attr("blog-event");typeof blog.events[t]=="function"&&blog.events[t].call(this)}).removeClass("byflow");n(".comment-item").find(".btnDiv,.layui-layedit,.createtime a,.reply").click(function(n){layui.stope(n)})}else layer.msg("获取数据失败",{icon:2,shift:6})},error:function(){layer.msg("获取数据失败",{icon:2,shift:6})}})}})});layui.use(["jquery","layedit","laytpl"],function(n,t,i){var s="/chatroom",u=0,r=n(".chatroom-body"),f=t.build("chateditor",{tool:["face","image"],height:"70"}),e=function(n){return'<p class="systemmsg">'+n+"<\/p>"},h=function(){n(".chatroom-editor").html('<textarea id="chateditor" style="display: none;"><\/textarea>');f=t.build("chateditor",{tool:["face","image"],height:"70"})},o={chatsend:function(){var n,u;if(hubConnection.connection.connectionState!=="Connected"){r.append(e("请先连接聊天室"));msg_end.scrollIntoView(!1);return}if(n=t.getContent(f),n==""){r.append(e("至少输入一个字吧！"));msg_end.scrollIntoView(!1);return}hubConnection.invoke("Send",n);u={msg:n,userAvatar:layui.cache.user.avatar,userName:layui.cache.user.name,"class":"msg-mine"};i(chatMsgTpl.innerHTML).render(u,function(n){r.append(n);msg_end.scrollIntoView(!1)});h()}};n("*[comment-event]").on("click",function(){var t=n(this).attr("comment-event");typeof o[t]=="function"&&o[t].call(this)});n(function(){window.hubConnection=(new signalR.HubConnectionBuilder).withUrl(s).withAutomaticReconnect().build();n(".chatroom .layui-card-header .status").on("click",function(t){var u=statusSelHtml.innerHTML,i=this;layer.open({offset:[t.clientY+20,t.clientX-20],type:1,shade:.1,shadeClose:!0,title:!1,closeBtn:0,content:u,success:function(t,u){n(t).find("li").click(function(){var f=n(this).data("status"),t;hubConnection.connection.connectionState==="Connected"&&f==="offline"?(n(i).removeClass("online").attr("title","离线"),hubConnection.stop(),n(".chatroom .layui-card-header .onlineCount").remove()):hubConnection.connection.connectionState!=="Connected"&&f==="online"&&(t=layer.msg("连接聊天服务器中...",{icon:16}),hubConnection.start().then(function(){layer.close(t);n(i).addClass("online").attr("title","在线");r.append('<p class="systemmsg">成功连接聊天室<\/p>');msg_end.scrollIntoView(!1)}).catch(n=>{layer.close(t),n.statusCode===401?layer.msg("登录后方可使用聊天室",{shift:6,icon:5}):(console.error(n.message),layer.msg("连接聊天服务器失败",{shift:6,icon:5}))}));layer.close(u)})}})});hubConnection.onreconnecting(()=>{r.append('<p class="systemmsg">正在尝试重新连接...<\/p>'),msg_end.scrollIntoView(!1)});hubConnection.onreconnected(()=>{r.append('<p class="systemmsg">已重新连接<\/p>'),msg_end.scrollIntoView(!1)});hubConnection.on("ReciveSystem",function(n){r.append('<p class="systemmsg">'+n+"<\/p>");msg_end.scrollIntoView(!1)});hubConnection.on("Recive",function(n){n.class=n.mine?"msg-mine":"msg-other";i(chatMsgTpl.innerHTML).render(n,function(n){r.append(n);msg_end.scrollIntoView(!1)})});hubConnection.on("UserOnline",function(t){r.append('<p class="systemmsg"><span style="color:#0094ff;margin-right:5px;">'+t+"<\/span>加入聊天室<\/p>");msg_end.scrollIntoView(!1);u++;n(".chatroom .layui-card-header .onlineCount").text("("+u+"人在线)")});hubConnection.on("UserOffline",function(t){r.append('<p class="systemmsg"><span style="color:#0094ff;margin-right:5px;">'+t+"<\/span>退出聊天室<\/p>");msg_end.scrollIntoView(!1);u--;n(".chatroom .layui-card-header .onlineCount").text("("+u+"人在线)")});hubConnection.on("OnlineCount",function(t){u=t;n(".chatroom .layui-card-header").append('<span class="onlineCount">('+u+"人在线)<\/span>")});hubConnection.onclose(function(){n(".chatroom .layui-card-header .status").removeClass("online").attr("title","离线");r.append('<p class="systemmsg">你已与聊天室断开连接<\/p>');msg_end.scrollIntoView(!1);n(".chatroom .layui-card-header .onlineCount").remove()})})});